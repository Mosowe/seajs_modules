<html lang="en">
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <title>canvas绘图</title>
    <link rel="stylesheet" href="public/css/reset.css">
    <style>
        body{ background-color:#999; padding:0; margin:0; padding-bottom:100px;}
        b{ display:block; width:20px; height:20px; text-align:center; line-height:20px; font-size:20px; color:#ddd; position:absolute; left:420px; top:420px; cursor:move;
            pmoz-user-select: -moz-none;
            -moz-user-select: none;
            -o-user-select:none;
            -khtml-user-select:none;
            -webkit-user-select:none;
            -ms-user-select:none;
            user-select:none;}
        .btnbox{ overflow:hidden; overflow-y: auto; width:300px; position:fixed; left:0; top:0; padding:20px 50px; background-color:#fff; box-shadow:0 0 10px #333;}
        .btnbox p{ font-size:18px; color:#333; line-height:30px; margin-bottom:10px;}
        .btnbox span{ display:inline-block; margin:10px; border:1px solid #999; border-radius:3px; padding:5px 10px; font-size:12px; color:#333; cursor:pointer}
        .btnbox span{ *display:inline}
        .btnbox span.active{ background-color:#666; color:#fff;}
        .btnbox input{ width:45px; margin:0 10px;}
        .btnbox input[type='checkbox']{ width:auto; margin:0 10px;}
        .btnbox div{ overflow:hidden; margin:10px 0}
        .doIt{ margin-top:20px; text-align:right; width:100%}
        .box{position:fixed; width:420px; height:420px; left:400px; top:0; padding:20px}
        canvas{ position:fixed; z-index:5; left:420px; top:20px; cursor: context-menu}
        #canvas{ background-color:#fff; box-shadow:0 0 10px #333;}
        #canbox{ width:400px; height:400px; position:relative}
        #bj,#bk,#wz,#zd{ display:none;}
        .link{ display:block; width:1200px; margin:30px auto; text-align:center}
    </style>
<head>
<body id="body">

    <div id="canbox">
        <canvas width="400" height="400" id="canvas">
            不支持canvas的浏览器可以看到的内容
        </canvas>
    </div>
    <div class="box" id="box">
        <b title="改变画布大小" id="changCan">+</b>
    </div>

    <div class="btnbox" id="btnbox">
        <div style="overflow: hidden; width: 100%">
            <div class="graphics" id="graphics">
                <p>图形选择</p>
                <span class="rect" id="rect">矩形</span>
                <span class="round" id="round">圆形</span>
                <span class="line" id="line">线</span>
            </div>
            <div class="style" id="style">
                <p>填充样式,边框样式</p>
                <span id="bj">半径<input type="text" value="" id="rr"></span>
                <span id="bk">宽<input type="text" value="" id="k">高<input type="text" value="" id="g"></span><div class="clear" style="margin:0"></div>
                <span>填充颜色<input type="text" value="" id="tcColor"></span><br>
                <span>边框颜色<input type="text" value="" id="bkColor"></span><br>
                <span>边框宽度<input type="text" value="" id="bkWidth"></span><div class="clear" style="margin:0"></div>
                <span id="zd"><label><input type="checkbox" name="bh" id="diejia">自动叠加图形</label><label><input type="checkbox" name="bh" id="rkg">宽高或半径改变</label></span><div class="clear" style="margin:0"></div>
                <span id="wz"><label><input type="checkbox" name="bh" id="closePath">网状</label></span>
            </div>
            <div class="canDone">
                <p>画布操作</p>
                <span>背景颜色<input type="text" value="" id="canBg"></span>
            </div>
            <div class="bodyDone">
                <p>界面背景颜色</p>
                <span>背景颜色<input type="text" value="" id="bodyBg"></span>
            </div>
            <div class="doIt">
                <!--<span id="send">确定</span>-->
                <span id="reset">重置</span>
                <span id="clearCan">清空画布</span>
                <span id="btn2">保存图片</span>
            </div>
        </div>

    </div>
    <script>
        document.getElementById('btnbox').style.height = (document.documentElement.clientHeight) + 'px'
    </script>
    <script>
        var canvas = document.getElementById("canvas");
        var box = document.getElementById("box");
        var send   = document.getElementById("send");
        var resetb   = document.getElementById("reset");
        var clearCan   = document.getElementById("clearCan");
        var changCan  = document.getElementById("changCan");
        var bodys  = document.getElementById("body");
        var bodybg = document.getElementById("bodyBg");
        var canWidth = document.getElementById("canWidth");
        var canHeight = document.getElementById("canHeight");
        var canColor = document.getElementById("canBg");
        var graphics = document.getElementById("graphics");
        var style = document.getElementById("style");
        var canbox = document.getElementById("canbox");
        var styleTcColor = '';
        var styleBkColor = '';
        var stylebkWidth = '';
        var graphicsChoose = '';
        var num=0;
        var graphicsSpan = graphics.getElementsByTagName("span");

        for(var i = 0; i< graphicsSpan.length; i++){
            graphicsSpan[i].index = i
            graphicsSpan[i].onclick = function(){
                graphicsChoose = this.id;
                for(var i = 0; i< graphicsSpan.length; i++){
                    graphicsSpan[i].className = '';
                }
                this.className += ' active';
                var n = this.index
                if(n == 0){
                    document.getElementById("bk").style.display = 'inline-block';
                    document.getElementById("zd").style.display = 'inline-block';
                    document.getElementById("bj").style.display = 'none';
                    document.getElementById("wz").style.display = 'none';
                    document.getElementById("rr").value = '';
                }
                if(n==1){
                    document.getElementById("bj").style.display = 'inline-block';
                    document.getElementById("zd").style.display = 'inline-block';
                    document.getElementById("bk").style.display = 'none';
                    document.getElementById("wz").style.display = 'none';
                    document.getElementById("k").value = '';
                    document.getElementById("g").value = '';
                }
                if(n == 2){
                    document.getElementById("bj").style.display = 'none';
                    document.getElementById("bk").style.display = 'none';
                    document.getElementById("zd").style.display = 'none';
                    document.getElementById("wz").style.display = 'inline-block';
                    document.getElementById("k").value = '';
                    document.getElementById("g").value = '';
                    document.getElementById("rr").value = '';
                }
            }
        }





        function border(){
            if(stylebkWidth || styleBkColor || styleTcColor){
                if(styleBkColor){
                    can.strokeStyle=''+styleBkColor+'';

                }
                if(stylebkWidth){
                    can.lineWidth=stylebkWidth;
                }

                if(styleTcColor){
                    can.fillStyle = ''+styleTcColor+'';
                    can.fill();
                }
                can.stroke();
            }else{
                can.stroke();
            }
            if(closePath){
                can.closePath();
            }
        }

        //开始作图,作图后改变画布大小会清除作图痕迹？？？
        var can = canvas.getContext("2d");


        canvas.onmousedown = function(ev){

            styleTcColor = document.getElementById("tcColor").value;
            styleBkColor = document.getElementById("bkColor").value;
            stylebkWidth = document.getElementById("bkWidth").value;
            closePath = document.getElementById("closePath").checked;
            diejia = document.getElementById("diejia").checked;
            rkg  = document.getElementById("rkg").checked;

            var r = document.getElementById("rr").value;
            var k = document.getElementById("k").value;
            var g = document.getElementById("g").value;
            var ev  = ev || window.event;
            can.beginPath();
            can.moveTo(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop);

            document.onmousemove = function(ev){
                var ev = ev || window.event;
                //can.lineTo(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop);
                if(rkg){
                    r++;
                    g++;
                    k++;
                }
                if(graphicsChoose == "line"){
                    can.lineTo(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop);
                }
                if(diejia){
                    if(graphicsChoose == "rect"){
                        can.rect(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop,k,g);
                    }
                    if(graphicsChoose == "round"){
                        can.arc(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop,r,0,Math.PI*2, true);
                    }
                }
                border();
            }//mousemove
            if(!diejia){

                if(graphicsChoose == "rect"){
                    can.rect(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop,k,g);

                }
                if(graphicsChoose == "round"){
                    can.arc(ev.clientX-canvas.offsetLeft,ev.clientY-canvas.offsetTop,r,0,Math.PI*2, true);
                }

            }
            document.onmouseup = function(){

                document.onmousemove = null;
                document.onmouseup = null;
            }//onmouseup
        }//onmousedown
        //清除画布
        clearCan.onclick = function(){
            can.clearRect(0,0,canvas.width,canvas.height);//在没有beginPath()的时候此方法清空下一次绘制时清空的图形又出来，有beginPath()则不会出现
            //canvas.width = canvas.width;//在没有beginPath()的时候可以通过改变canvas宽高来清除画布，不会出现上次的画面
        }
        //重置界面
        resetb.onclick = function(){
            location.reload()
        }
        //界面背景改变
        bodybg.onkeyup = function(){
            bodys.style.backgroundColor = this.value;
        }
        //画布背景改变
        canColor.onkeyup = function(){
            canvas.style.backgroundColor = this.value;
            //canvas.style.boxShadow = '0px 0px 10px '+canColor.value;
        }

        //画布大小改变
        changCan.onmousedown =function(ev){
            can.save();
            var ev = ev||event;
            var x = ev.clientX-this.offsetLeft;
            var y = ev.clientY-this.offsetTop;

            document.onmousemove =function(ev){
                var ev = ev||event;
                changCan.style.left = ev.clientX - x +"px";
                changCan.style.top = ev.clientY - y+"px";
                canvas.width = ev.clientX - x-20;
                canvas.height = ev.clientY - y-20;
                box.style.width = ev.clientX - x +"px";
                box.style.height = ev.clientY - y +"px";
            }
            document.onmouseup = function(){
                document.onmousemove = null;
                document.onmouseup = null;

            }
        }



        //图片下载
        document.getElementById('btn2').onclick = function () {
            var type = 'png';
            download(type);
        }
        //图片下载操作,指定图片类型
        function download(type) {
            //设置保存图片的类型
            var imgdata = canvas.toDataURL(type);
            //将mime-type改为image/octet-stream,强制让浏览器下载
            var fixtype = function (type) {
                type = type.toLocaleLowerCase().replace(/jpg/i, 'jpeg');
                var r = type.match(/png|jpeg|bmp|gif/)[0];
                return 'image/' + r;
            }
            imgdata = imgdata.replace(fixtype(type), 'image/octet-stream')
            //将图片保存到本地
            var saveFile = function (data, filename) {
                var link = document.createElement('a');
                link.href = data;
                link.download = filename;
                var event = document.createEvent('MouseEvents');
                event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                link.dispatchEvent(event);
            }
            var filename = new Date().toLocaleDateString() + '.' + type;
            saveFile(imgdata, filename);
        }


    </script>


</body>
